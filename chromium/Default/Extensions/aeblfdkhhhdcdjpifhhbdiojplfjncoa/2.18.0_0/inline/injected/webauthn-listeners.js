(function () {
	'use strict';

	const e=e=>{throw new Error("Unexpected value.")},t=()=>globalThis.crypto.getRandomValues(new Uint32Array(1))[0].toString(36),n=()=>{let e;return {resolve:t=>e(t),promise:new Promise((t=>{e=t;}))}};var i;!function(e){e.Create="create-credential",e.Get="get-credential",e.ShouldInterceptWebauthn="should-intercept-webauthn";}(i||(i={}));const o=e=>{if(!e)return a();if(e.aborted)return Promise.resolve({type:"aborted"});const t=n(),i=()=>{t.resolve({type:"aborted"}),e.removeEventListener("abort",i);};return e.addEventListener("abort",i),t.promise},r=e=>"string"==typeof e&&0!==e.length,s=e=>e instanceof ArrayBuffer||e instanceof window.ArrayBuffer||e instanceof Uint8Array||e instanceof window.Uint8Array||e instanceof DataView||e instanceof window.DataView||e instanceof Array||e instanceof window.Array?Array.from(e instanceof ArrayBuffer||e instanceof window.ArrayBuffer?new Uint8Array(e):e):e,a=()=>new Promise((()=>{}));function d(){return "function"==typeof globalThis.cloneInto?globalThis.cloneInto:void 0}function c(e){const t=d();return t?t(e,window,{cloneFunctions:!0,wrapReflectors:!0}):e}function l(e){const t=d();return t?new window.Promise(((n,i)=>{e.then((e=>{n(t(e,window,{cloneFunctions:!0,wrapReflectors:!0}));})).catch((e=>{i(e);}));})):e}class u{constructor(e){this.send=async(e,{body:n,signal:i})=>{const o=t(),r=await this.handleOutgoingSyn(o,e,i);if("ack"!==r.type)return r;const s=r.data;return (await this.handleOutgoingDirect(s.ackedById,o,e,n,i)).data},this.handleOutgoingSyn=async(e,t,i)=>{const r=o(i),s={msgId:e,source:this.source,type:u.opSynType,message:void 0,name:t};this.log.debug("starting request sequence",t);const a=n();this.synRequests[e]=a,window.postMessage(s),this.log.debug("starting ack race",t);const d=await Promise.race([a.promise,(c=1e3,new Promise((e=>{setTimeout((()=>e({type:"timeout"})),c);}))),r]);var c;if("timeout"===d.type)return this.log.debug("finished request sequence: ack timed out",t),delete this.synRequests[e],{type:u.NoReceivingEnd};if("aborted"===d.type||(null==i?void 0:i.aborted))return this.log.debug("finished request sequence: aborted sync",t),delete this.synRequests[e],this.throwAbort(i);this.log.debug(`ack race won by: ${d.data.ackedById}`,t);const l=n();return this.directRequests[e]=l,d},this.handleIncomingSyn=async e=>{if(!this.routes[e.name])return void this.log.debug("received a request with no handler to call",e.name);const t={msgId:e.msgId,source:this.source,destination:e.source,name:e.name,type:u.opSynAckType,message:void 0};window.postMessage(t);},this.handleIncomingSynAck=e=>{if(void 0===this.synRequests[e.msgId])return;this.synRequests[e.msgId].resolve({type:"ack",data:{ackedById:e.source}}),delete this.synRequests[e.msgId];},this.handleOutgoingDirect=async(e,t,i,r,s)=>{const a=o(s),d=n();this.directRequests[t]=d;const c={msgId:t,source:this.source,destination:e,type:u.opDirectRequestType,message:r,name:i};this.log.debug(`sending direct request to: ${e}`,i),window.postMessage(c);const l=await Promise.race([d.promise,a]);if(delete this.directRequests[t],"aborted"===l.type){const e=c;return e.type=u.opAbortType,this.log.debug("notifying receiver to abort",i),window.postMessage(e),this.log.debug("finished request sequence: aborted",i),this.throwAbort(s)}return this.log.debug("finished request sequence: success",i),l},this.handleIncomingDirectRequest=async e=>{const t=this.routes[e.name];if(!t)return void this.log.error("received a request with no handler to call",e.name);const n=new AbortController;this.abortableRequests[e.msgId]=n;const i=o(n.signal),r=await Promise.race([t({body:e.message,signal:n.signal}),i]);delete this.abortableRequests[e.msgId];const s=r;if(s&&"aborted"===(null==s?void 0:s.type))return;const a={msgId:e.msgId,source:this.source,destination:e.source,name:e.name,type:u.opDirectResponseType,message:r};window.postMessage(a);},this.handleIncomingAbortRequest=e=>{if(void 0===this.abortableRequests[e.msgId])return void this.log.debug(`received abort ${e.msgId} for no active request - likely already completed`,e.name);this.abortableRequests[e.msgId].abort(),delete this.abortableRequests[e.msgId];},this.handleIncomingResponse=e=>{if(void 0===this.directRequests[e.msgId])return void this.log.debug(`received response ${e.msgId} with no promise to resolve - likely already aborted`,e.name);this.directRequests[e.msgId].resolve({type:"completed",data:e.message}),delete this.directRequests[e.msgId];},this.throwAbort=e=>{if(null==e?void 0:e.reason)throw new DOMException(null==e?void 0:e.reason,"AbortError");throw new DOMException("signal is aborted without reason","AbortError")},this.validateMessage=e=>{const t="validate";if("object"!=typeof e||null===e)return this.log.debug("invalid message - not an object",t),!1;const n=e;return r(n.msgId)?r(n.source)?r(n.name)?n.type===u.opSynType||n.type===u.opSynAckType||n.type===u.opAbortType||n.type===u.opDirectRequestType||n.type===u.opDirectResponseType||(this.log.debug("invalid message: type unsupported",t),!1):(this.log.debug("invalid message - missing name",t),!1):(this.log.debug("invalid message - missing source",t),!1):(this.log.debug("invalid message - missing msgId",t),!1)},this.routes=e,this.synRequests={},this.abortableRequests={},this.directRequests={},this.source=t(),this.debug=!1,this.log={error:(e,t)=>console.error(`PWM-${this.source}-${t}: ${e}`),debug:(e,t)=>{this.debug&&console.info(`PWM-${this.source}-${t}: ${e}`);}},window.addEventListener("message",(e=>{if(!this.validateMessage(e.data))return;const t=e.data;if(t.source===this.source)return;if(t.destination&&t.destination!==this.source)return;const{type:n}=t;n===u.opSynType&&this.handleIncomingSyn(t),n===u.opSynAckType&&this.handleIncomingSynAck(t),n===u.opAbortType&&this.handleIncomingAbortRequest(t),n===u.opDirectRequestType&&this.handleIncomingDirectRequest(t),n===u.opDirectResponseType&&this.handleIncomingResponse(t);}));}}var w,p,g,h,y,b,v,f;u.opSynType="op-window-syn",u.opSynAckType="op-window-syn-ack",u.opAbortType="op-window-abort",u.opDirectRequestType="op-window-direct-request",u.opDirectResponseType="op-window-direct-response",u.NoReceivingEnd="no-receiving-end";const m=null===(p=null===(w=window.navigator)||void 0===w?void 0:w.credentials)||void 0===p?void 0:p.get.bind(window.navigator.credentials),A=null===(h=null===(g=window.navigator)||void 0===g?void 0:g.credentials)||void 0===h?void 0:h.create.bind(window.navigator.credentials),R=null===(b=null===(y=window.PublicKeyCredential)||void 0===y?void 0:y.isConditionalMediationAvailable)||void 0===b?void 0:b.bind(window.PublicKeyCredential),q=null===(f=null===(v=window.PublicKeyCredential)||void 0===v?void 0:v.isUserVerifyingPlatformAuthenticatorAvailable)||void 0===f?void 0:f.bind(window.PublicKeyCredential),I=new u({}),T=new Promise((e=>{window.document.prerendering?document.addEventListener("prerenderingchange",e):e(void 0);})),O=({data:e})=>{var t;const n={clientDataJSON:new Uint8Array(e.response.clientDataJSON).buffer,authenticatorData:new Uint8Array(e.response.authenticatorData).buffer,signature:new Uint8Array(e.response.signature).buffer,userHandle:e.response.userHandle?new Uint8Array(e.response.userHandle).buffer:null};Object.setPrototypeOf(n,AuthenticatorAssertionResponse.prototype);const i={id:e.id,rawId:new Uint8Array(e.rawId),type:e.type,authenticatorAttachment:null!==(t=e.authenticatorAttachment)&&void 0!==t?t:null,response:n,getClientExtensionResults:()=>{var t;return c(null!==(t=e.clientExtentionResults)&&void 0!==t?t:{})}};return Object.setPrototypeOf(i,PublicKeyCredential.prototype),i},P=({data:e})=>{var t;const n={attestationObject:new Uint8Array(e.response.attestationObject).buffer,clientDataJSON:new Uint8Array(e.response.clientDataJSON).buffer,getTransports:()=>{var t;return null!==(t=e.response.transports)&&void 0!==t?t:[]},getAuthenticatorData:()=>{var t;return new Uint8Array(null!==(t=e.response.authenticatorData)&&void 0!==t?t:[]).buffer},getPublicKey:()=>e.response.publicKey?new Uint8Array(e.response.publicKey).buffer:null,getPublicKeyAlgorithm:()=>e.response.publicKeyAlgorithm};Object.setPrototypeOf(n,AuthenticatorAttestationResponse.prototype);const i={id:e.id,rawId:new Uint8Array(e.rawId).buffer,type:e.type,authenticatorAttachment:null!==(t=e.authenticatorAttachment)&&void 0!==t?t:null,response:n,getClientExtensionResults:()=>{var t;return c(null!==(t=e.clientExtentionResults)&&void 0!==t?t:{})}};return Object.setPrototypeOf(i,PublicKeyCredential.prototype),i},S=async()=>(await T,(async()=>{const e={type:"should-intercept-webauthn-request",data:void 0},t=await I.send(i.ShouldInterceptWebauthn,{body:e});return t.type!==u.NoReceivingEnd&&"should-intercept-webauthn-error"!==t.type&&t.data})());async function D(t){if(!await S()){if(A)return A(t);throw new DOMException("The operation either timed out or was not allowed. See https://www.w3.org/TR/webauthn-2/#sctn-privacy-considerations-client.","NotAllowedError")}return (async t=>{const n=Object.assign({},t);null==n||delete n.signal;const o={type:"create-credential-request",data:JSON.stringify(n,((e,t)=>s(t)))},r=await I.send(i.Create,{body:o});if(r.type===u.NoReceivingEnd)return A(t);if("create-credential-error"===r.type){if("timeout"===r.data.reason)throw new DOMException("The operation either timed out or was not allowed. See https://www.w3.org/TR/webauthn-2/#sctn-privacy-considerations-client.","NotAllowedError");if("duplicate"===r.data.reason)throw new DOMException("The user attempted to register an authenticator that contains one of the credentials already registered with the relying party.","InvalidStateError");return "user-cancelled"===r.data.reason?null:("fallback-requested"===r.data.reason||"internal-error"===r.data.reason||"invalid-request"===r.data.reason||e(r.data.reason),A(t))}return P(r)})(t)}async function E(t){if(!await S()){if(m)return m(t);throw new DOMException("The operation either timed out or was not allowed. See https://www.w3.org/TR/webauthn-2/#sctn-privacy-considerations-client.","NotAllowedError")}return (async t=>{var n;const o=Object.assign({},t);null==o||delete o.signal,"conditional"===o.mediation&&(null===(n=o.publicKey)||void 0===n?void 0:n.timeout)&&(o.publicKey.timeout=void 0);const r={type:"get-credential-request",data:JSON.stringify(o,((e,t)=>s(t)))},d=await I.send(i.Get,{body:r});if(d.type===u.NoReceivingEnd)return m(t);if("get-credential-error"===d.type){if("timeout"===d.data.reason)throw new DOMException("The operation either timed out or was not allowed. See https://www.w3.org/TR/webauthn-2/#sctn-privacy-considerations-client.","NotAllowedError");if("conditional"===o.mediation&&"user-cancelled"===d.data.reason)return a();if("conditional"===o.mediation&&"fallback-requested"===d.data.reason){const e=Object.assign({},t);return delete e.mediation,m(e)}return "user-cancelled"===d.data.reason?null:("fallback-requested"===d.data.reason||"internal-error"===d.data.reason||"invalid-request"===d.data.reason||e(d.data.reason),m(t))}return O(d)})(t)}async function k(){return !!await S()||!!R&&R()}async function M(){return !!await S()||!!q&&q()}const C=()=>{const e="function"==typeof globalThis.exportFunction?globalThis.exportFunction:void 0;e?(e((e=>l(D(e))),window.navigator.credentials,{defineAs:"create"}),e((e=>l(E(e))),window.navigator.credentials,{defineAs:"get"}),e((()=>l(k())),window.PublicKeyCredential,{defineAs:"isConditionalMediationAvailable"}),e((()=>l(M())),window.PublicKeyCredential,{defineAs:"isUserVerifyingPlatformAuthenticatorAvailable"})):(window.navigator.credentials.create=D,window.navigator.credentials.get=E,window.PublicKeyCredential.isConditionalMediationAvailable=k,window.PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable=M);},U=()=>{if(window.navigator.credentials.create.length>0&&window.navigator.credentials.get.length>0)return;const e=window.wrappedJSObject?window.wrappedJSObject:void 0;e&&e.navigator.credentials.create.length>0&&e.navigator.credentials.get.length>0||C();};window.navigator.credentials&&(C(),setInterval(U,100));

})();
